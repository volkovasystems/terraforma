"use strict";var _=require("lodash"),harden=require("harden"),gulp=require("gulp"),fs=require("fs"),path=require("path"),argv=require("yargs").argv,changed=require("gulp-changed"),plumber=require("gulp-plumber"),del=require("del"),vinylPath=require("vinyl-paths"),map=require("map-stream"),concat=require("gulp-concat"),rename=require("gulp-rename"),less=require("gulp-less"),sass=require("gulp-sass"),cached=require("gulp-cached"),flatten=require("gulp-flatten"),babel=require("gulp-babel"),parameta=require("parameta"),util=require("util"),uglify=require("gulp-uglify"),cssnano=require("gulp-cssnano"),sourcemap=require("gulp-sourcemaps"),order=require("gulp-order");harden("ROOT_DIRECTORY",__dirname,global);var terraforma=function(e){gulp.task("initialize",function(){var i=path.resolve(ROOT_DIRECTORY,"earth.json");try{if(!fs.existsSync(i)){var p=fs.readFileSync("./earth.template.json","utf8");p=JSON.parse(p),p=_.extend(p,e),p=JSON.stringify(p,null,"	"),fs.writeFileSync(i,p,"utf8")}}catch(r){console.log("possible error during earth.json template transfer",util.inspect(r)),fs.existsSync(i)||(console.log("earth.json is not created properly, terraforma will crumble"),process.exit(0))}return gulp.src(i).pipe(map(function(i,p){e=_.extend(e||{},JSON.parse(i.contents.toString("utf8")||"{ }")),harden("OPTION",e,global),harden("APPLICATION_NAME",argv.appName||e.appName||"app",global);var r=argv.mode||e.mode;argv.cloud?r="cloud":argv.ground?r="ground":argv.ios?r="mobile:ios":argv.android?r="mobile:android":argv.mobile?r="mobile":r||(r="water"),harden("TERRAFORM_MODE",r.split(":")[0],global),/^moon\:/.test(r)&&harden("MOBILE_MODE",r.split(":")[1],global),e.destinationPath||("cloud"==TERRAFORM_MODE?e.destinationPath="deploy":"ground"==TERRAFORM_MODE?e.destinationPath="stage":"moon"!=TERRAFORM_MODE||global.MOBILE_MODE?e.destinationPath="build":e.destinationPath="mobile"),harden("SOURCE_PATH",path.resolve(ROOT_DIRECTORY,argv.sourcePath||e[TERRAFORM_MODE||"water"].sourcePath||e.sourcePath||"client"),global),harden("DESTINATION_PATH",path.resolve(ROOT_DIRECTORY,[argv.destinationPath||(global.MOBILE_MODE?MOBILE_MODE:"")||e[TERRAFORM_MODE||"water"].destinationPath||e.destinationPath,APPLICATION_NAME].join("-")),global);var s=["bower_components/*/*.css","bower_components/*/*.map","bower_components/*/*.js","bower_components/*/*.eot","bower_components/*/*.svg","bower_components/*/*.ttf","bower_components/*/*.woff","bower_components/*/dist/**/*.eot","bower_components/*/dist/**/*.svg","bower_components/*/dist/**/*.ttf","bower_components/*/dist/**/*.woff","bower_components/*/dist/**/*.css","bower_components/*/dist/**/*.map","bower_components/*/dist/**/*.js","bower_components/*/lib/**/*.js","bower_components/*/build/**/*.js","bower_components/*/build/**/*.css","bower_components/*/css/*.css","bower_components/*/fonts/*.eot","bower_components/*/fonts/*.svg","bower_components/*/fonts/*.ttf","bower_components/*/fonts/*.woff"],l=_.union(s,e.libraryPathList).map(function(e){return path.resolve(ROOT_DIRECTORY,e)});harden("LIBRARY_PATH_LIST",l,global);var a=path.join(ROOT_DIRECTORY,"bower_components");harden("INITIAL_LIBRARY_PATH",a,global);var t=path.join(SOURCE_PATH,"library");harden("SOURCE_LIBRARY_PATH",t,global);var o=path.join(DESTINATION_PATH,"library");harden("DESTINATION_LIBRARY_PATH",o,global);var n="!"+path.resolve(SOURCE_PATH,"library/**/*.*");harden("NEGATED_LIBRARY_PATH",n,global);var T=path.resolve(SOURCE_PATH,"fonts");harden("SOURCE_FONT_PATH",T,global);var u=path.resolve(DESTINATION_PATH,"fonts");harden("DESTINATION_FONT_PATH",u,global);var A="!"+path.resolve(SOURCE_PATH,"fonts/**/*.*");harden("NEGATED_FONT_PATH",A,global);var c=path.resolve(DESTINATION_PATH,"css");harden("DESTINATION_CSS_PATH",c,global);var I=path.resolve(DESTINATION_PATH,"style");harden("DESTINATION_STYLE_PATH",I,global);var E=["jpg","jpeg","png","gif","svg","ico"],d=_.union(E,e.imageFileFormatList||[]).map(function(e){return path.resolve(SOURCE_PATH,"**/*."+e)});harden("IMAGE_FILE_PATH_LIST",d,global);var g=path.resolve(DESTINATION_PATH,"image");harden("DESTINATION_IMAGE_PATH",g,global);var O=e.scriptPathList;_.isEmpty(O)?(O=[path.resolve(SOURCE_PATH,"**/*.js"),path.resolve(SOURCE_PATH,"**/*.jsx")],harden("ORDERED_SCRIPT",!1,global)):harden("ORDERED_SCRIPT",!0,global),harden("SCRIPT_PATH_LIST",O,global);var P=path.resolve(DESTINATION_PATH,"js");harden("DESTINATION_JS_PATH",P,global);var b=path.resolve(DESTINATION_PATH,"script");harden("DESTINATION_SCRIPT_PATH",b,global),p(null,i)}))}),gulp.task("copy-library",["initialize"],function(){return gulp.src(LIBRARY_PATH_LIST).pipe(plumber()).pipe(flatten()).pipe(changed(SOURCE_LIBRARY_PATH)).pipe(gulp.dest(SOURCE_LIBRARY_PATH))}),gulp.task("build-library",["initialize","copy-library"],function(){return gulp.src(path.resolve(SOURCE_LIBRARY_PATH,"*.*")).pipe(plumber()).pipe(changed(DESTINATION_LIBRARY_PATH)).pipe(gulp.dest(DESTINATION_LIBRARY_PATH))}),gulp.task("build-font",["initialize","copy-library"],function(){gulp.src([path.resolve(SOURCE_LIBRARY_PATH,"*.eot"),path.resolve(SOURCE_LIBRARY_PATH,"*.svg"),path.resolve(SOURCE_LIBRARY_PATH,"*.ttf"),path.resolve(SOURCE_LIBRARY_PATH,"*.woff")]).pipe(plumber()).pipe(changed(SOURCE_FONT_PATH)).pipe(gulp.dest(SOURCE_FONT_PATH)).pipe(gulp.dest(DESTINATION_FONT_PATH))}),gulp.task("build-sass",["initialize"],function(){return gulp.src([path.resolve(SOURCE_PATH,"**/*.scss"),NEGATED_LIBRARY_PATH]).pipe(plumber()).pipe(cached("sass:build",{optimizeMemory:!0})).pipe(sass()).pipe(rename([APPLICATION_NAME,"sass.css"].join("."))).pipe(gulp.dest(DESTINATION_CSS_PATH))}),gulp.task("build-less",["initialize"],function(){return gulp.src([path.resolve(SOURCE_PATH,"**/*.less"),NEGATED_LIBRARY_PATH]).pipe(plumber()).pipe(cached("less:build",{optimizeMemory:!0})).pipe(less()).pipe(rename([APPLICATION_NAME,"less.css"].join("."))).pipe(gulp.dest(DESTINATION_CSS_PATH))}),gulp.task("build-css",["initialize"],function(){return gulp.src([path.resolve(SOURCE_PATH,"**/*.css"),NEGATED_LIBRARY_PATH]).pipe(plumber()).pipe(cached("css:build",{optimizeMemory:!0})).pipe(gulp.dest(DESTINATION_CSS_PATH))}),gulp.task("build-style",["initialize","build-sass","build-less","build-css"],function(){return"cloud"==TERRAFORM_MODE?gulp.src(path.resolve(DESTINATION_CSS_PATH,"*.css")).pipe(plumber()).pipe(order(["**/*.sass.css","**/*.less.css","**/*.css"])).pipe(concat([APPLICATION_NAME,"css"].join("."))).pipe(gulp.dest(DESTINATION_STYLE_PATH)).pipe(sourcemap.init()).pipe(cssnano()).pipe(sourcemap.write(DESTINATION_STYLE_PATH)).pipe(rename([APPLICATION_NAME,"min.css"].join("."))).pipe(changed(DESTINATION_STYLE_PATH)).pipe(gulp.dest(DESTINATION_STYLE_PATH)):gulp.src(path.resolve(DESTINATION_CSS_PATH,"*.css")).pipe(plumber()).pipe(order(["**/*.sass.css","**/*.less.css","**/*.css"])).pipe(concat([APPLICATION_NAME,"css"].join("."))).pipe(changed(DESTINATION_STYLE_PATH)).pipe(gulp.dest(DESTINATION_STYLE_PATH))}),gulp.task("build-image",["initialize"],function(){return gulp.src(_.union([NEGATED_LIBRARY_PATH,NEGATED_FONT_PATH],IMAGE_FILE_PATH_LIST)).pipe(plumber()).pipe(changed(DESTINATION_IMAGE_PATH)).pipe(gulp.dest(DESTINATION_IMAGE_PATH))}),gulp.task("compile-script",["initialize"],function(){return gulp.src(_.union([NEGATED_LIBRARY_PATH],SCRIPT_PATH_LIST)).pipe(plumber()).pipe(cached("script:compile",{optimizeMemory:!0})).pipe(babel({presets:["es2015"]})).pipe(gulp.dest(DESTINATION_JS_PATH))}),gulp.task("compile-react",["initialize"],function(){return gulp.src([NEGATED_LIBRARY_PATH,path.resolve(SOURCE_PATH,"**/*.jsx")]).pipe(plumber()).pipe(cached("script:compile",{optimizeMemory:!0})).pipe(babel({presets:["react"]})).pipe(gulp.dest(DESTINATION_JS_PATH))}),gulp.task("build-script",["initialize","compile-react","compile-script"],function(){return"cloud"==TERRAFORM_MODE?gulp.src(path.resolve(DESTINATION_JS_PATH,"*.js")).pipe(plumber()).pipe(concat([APPLICATION_NAME,"js"].join("."))).pipe(gulp.dest(DESTINATION_SCRIPT_PATH)).pipe(sourcemap.init()).pipe(uglify({comments:/\/\/\:\!|\/\*\:\!/})).pipe(sourcemap.write(DESTINATION_SCRIPT_PATH)).pipe(rename([APPLICATION_NAME,"min.js"].join("."))).pipe(changed(DESTINATION_SCRIPT_PATH)).pipe(gulp.dest(DESTINATION_SCRIPT_PATH)):gulp.src(path.resolve(DESTINATION_JS_PATH,"*.js")).pipe(plumber()).pipe(concat([APPLICATION_NAME,"js"].join("."))).pipe(gulp.dest(DESTINATION_SCRIPT_PATH))}),gulp.task("build-index",["initialize"],function(){}),gulp.task("build",["initialize","copy-library","build-library","build-font","build-image","build-sass","build-less","build-css","build-style","compile-react","compile-script","build-script","build-index"]),gulp.task("clean-library",["initialize"],function(){return gulp.src(SOURCE_LIBRARY_PATH,{read:!1}).pipe(plumber()).pipe(vinylPath(del))}),gulp.task("clean-build",["initialize"],function(){return gulp.src(DESTINATION_PATH,{read:!1}).pipe(plumber()).pipe(vinylPath(del))}),gulp.task("clean",["initialize","clean-library","clean-build"]),gulp.task("default",["initialize","clean","build"])};module.exports=terraforma;
//# sourceMappingURL=terraforma.min.js.map